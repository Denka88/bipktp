<!doctype html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${ctp.name}"></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.14.0-beta2/css/bootstrap-select.min.css">
    <style>
        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        .table-container {
            margin-top: 2rem;
        }
        .add-btn-cell {
            border: 2px dashed #ccc;
            text-align: center;
            cursor: pointer;
        }
        .add-btn-cell:hover {
            background-color: #f8f9fa;
        }
        .context-menu {
            position: absolute;
            z-index: 1000;
            display: none;
            background-color: white;
            border: 1px solid #ddd;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            border-radius: 4px;
            padding: 5px 0;
        }
        .context-menu-item {
            padding: 5px 15px;
            cursor: pointer;
        }
        .context-menu-item:hover {
            background-color: #f8f9fa;
        }
        .record-row:hover {
            background-color: #f8f9fa;
            cursor: pointer;
        }
        .modal-content {
            border-radius: 10px;
        }
        .modal-header {
            background-color: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }
        .modal-footer {
            border-top: 1px solid #dee2e6;
        }
        .form-label {
            font-weight: 500;
        }
        .bootstrap-select .dropdown-toggle {
            border: 1px solid #ced4da;
            background-color: white;
        }
        .bootstrap-select .dropdown-toggle:focus {
            border-color: #86b7fe;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }
        .record-row.active {
            background-color: #e9ecef;
        }
    </style>
</head>
<body class="bg-light">
<div class="container py-4">
    <div class="header-container">
        <h2 th:text="${ctp.name}"></h2>
        <button class="btn btn-sm btn-outline-secondary" id="editTitleBtn">
            <i class="bi bi-pencil"></i> Изменить КТП
        </button>
    </div>

    <div class="table-container">
        <table class="table table-bordered">
            <thead class="table-light">
            <tr>
                <th style="width: 5%">№</th>
                <th style="width: 25%">Тема</th>
                <th style="width: 5%">Часы</th>
                <th style="width: 15%">Оборудование</th>
                <th style="width: 10%">Тип занятия</th>
                <th style="width: 15%">Методы обучения</th>
                <th style="width: 25%">Домашнее задание</th>
            </tr>
            </thead>
            <tbody th:each="chapter : ${ctp.chapters}">
            <tr>
                <td colspan="7" class="table-primary">
                    <div class="d-flex justify-content-between align-items-center">
                        <strong th:text="${chapter.title}"></strong>
                        <button class="btn btn-sm btn-outline-primary add-record-btn"
                                th:attr="data-chapter-id=${chapter.id}">
                            <i class="bi bi-plus-lg"></i> Добавить занятие
                        </button>
                    </div>
                </td>
            </tr>
            <tr th:each="record, recIter : ${chapter.records}" class="record-row"
                th:attr="data-record-id=${record.id}, data-chapter-id=${chapter.id}">
                <td th:text="${recIter.count}"></td>
                <td th:text="${record.title}"></td>
                <td th:text="${record.hours}"></td>
                <td th:text="${record.equipment}"></td>
                <td th:text="${record.lessonType.name}"></td>
                <td>
                    <span th:each="method, iter : ${record.teachMethods}" th:text="${method.name}">
                        <span th:if="${!iter.last}">, </span>
                    </span>
                </td>
                <td th:text="${record.homework}"></td>
            </tr>
            <tr>
                <td colspan="7" class="add-btn-cell">
                    <button class="btn btn-sm btn-outline-primary add-chapter-btn">
                        <i class="bi bi-plus-lg"></i> Добавить раздел
                    </button>
                </td>
            </tr>
            </tbody>
        </table>
    </div>

    <div class="modal fade" id="recordModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="recordModalTitle">Добавить новое занятие</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="recordForm" th:object="${newRecord}" method="post" th:action="@{/ctps/ctp/{id}/save(id=${ctp.id})}">
                        <input type="hidden" id="recordId" name="id">
                        <input type="hidden" id="ctpId" th:value="${ctp.id}">
                        <input type="hidden" id="chapterId" name="chapterId">
                        <input type="hidden" name="updateId" id="updateId" value="">

                        <div class="row mb-3">
                            <div class="col-md-8">
                                <label for="recordTitle" class="form-label">Тема занятия</label>
                                <input type="text" class="form-control" id="recordTitle" name="title" th:field="*{title}" required>
                            </div>
                            <div class="col-md-4">
                                <label for="recordHours" class="form-label">Часы</label>
                                <input type="number" class="form-control" id="recordHours" min="1" name="hours" th:field="*{hours}" required>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="recordEquipment" class="form-label">Оборудование</label>
                            <input type="text" class="form-control" id="recordEquipment" name="equipment" th:field="*{equipment}">
                        </div>

                        <div class="mb-3">
                            <label for="recordLessonType" class="form-label">Тип занятия</label>
                            <select class="form-select" id="recordLessonType" th:field="*{lessonType}" name="lessonType" required>
                                <option th:each="lessonType : ${lessonTypes}" th:value="${lessonType.id}" th:text="${lessonType.name}"></option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="teachMethodsSelect" class="form-label">Методы обучения</label>
                            <select class="selectpicker" multiple data-live-search="true" data-style="btn-light"
                                    data-width="100%" id="teachMethodsSelect" name="teachMethodsIds">
                                <option th:each="method : ${teachMethods}"
                                        th:value="${method.id}"
                                        th:text="${method.name}"></option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="recordHomework" class="form-label">Домашнее задание</label>
                            <textarea class="form-control" id="recordHomework" rows="3" maxlength="255" th:field="*{homework}"></textarea>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                            <button type="submit" class="btn btn-primary" id="saveRecordBtn">Сохранить</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Контекстное меню для записей -->
    <div class="context-menu" id="recordContextMenu">
        <div class="context-menu-item" id="editRecordItem">
            <i class="bi bi-pencil"></i> Редактировать
        </div>
        <div class="context-menu-item" id="deleteRecordItem">
            <i class="bi bi-trash"></i> Удалить
        </div>
    </div>

    <!-- Контекстное меню для разделов -->
    <div class="context-menu" id="chapterContextMenu">
        <div class="context-menu-item" id="editChapterItem">
            <i class="bi bi-pencil"></i> Редактировать раздел
        </div>
        <div class="context-menu-item" id="deleteChapterItem">
            <i class="bi bi-trash"></i> Удалить раздел
        </div>
        <div class="context-menu-item" id="addRecordToChapterItem">
            <i class="bi bi-plus-lg"></i> Добавить занятие
        </div>
    </div>

    <!-- Модальное окно подтверждения удаления -->
    <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Подтверждение удаления</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Вы уверены, что хотите удалить эту запись?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <form method="post" th:action="@{/ctps/ctp/{id}/delete(id=${ctp.id})}">
                        <input type="hidden" name="deleteId" id="deleteId" value="">
                        <button type="submit" class="btn btn-danger">Удалить</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.14.0-beta2/js/bootstrap-select.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Инициализация Bootstrap Select
        $('.selectpicker').selectpicker();

        // Элементы контекстного меню для записей
        const recordContextMenu = document.getElementById('recordContextMenu');
        const editRecordItem = document.getElementById('editRecordItem');
        const deleteRecordItem = document.getElementById('deleteRecordItem');

        // Элементы контекстного меню для разделов
        const chapterContextMenu = document.getElementById('chapterContextMenu');
        const editChapterItem = document.getElementById('editChapterItem');
        const deleteChapterItem = document.getElementById('deleteChapterItem');
        const addRecordToChapterItem = document.getElementById('addRecordToChapterItem');

        // Модальное окно удаления
        const confirmDeleteModal = new bootstrap.Modal(document.getElementById('confirmDeleteModal'));
        const deleteIdInput = document.getElementById('deleteId');

        let selectedRecordId = null;
        let selectedChapterId = null;

        const recordModal = new bootstrap.Modal(document.getElementById('recordModal'));
        const recordModalTitle = document.getElementById('recordModalTitle');
        const saveRecordBtn = document.getElementById('saveRecordBtn');

        const recordIdInput = document.getElementById('recordId');
        const chapterIdInput = document.getElementById('chapterId');
        const recordTitleInput = document.getElementById('recordTitle');
        const recordHoursInput = document.getElementById('recordHours');
        const recordEquipmentInput = document.getElementById('recordEquipment');
        const recordLessonTypeSelect = document.getElementById('recordLessonType');
        const teachMethodsSelect = $('#teachMethodsSelect');
        const recordHomeworkTextarea = document.getElementById('recordHomework');

        // Проверка параметра deleteId в URL
        const urlParams = new URLSearchParams(window.location.search);
        const deleteIdFromUrl = urlParams.get('deleteId');
        const updateIdFromUrl = urlParams.get('updateId');

        const recordForm = document.getElementById('recordForm');
        const ctpId = document.getElementById('ctpId');

        if (deleteIdFromUrl) {
            // Устанавливаем ID для удаления и показываем модальное окно
            deleteIdInput.value = deleteIdFromUrl;
            confirmDeleteModal.show();
        }

        if (updateIdFromUrl) {
            // Находим строку с записью для редактирования
            const recordRow = document.querySelector(`.record-row[data-record-id="${updateIdFromUrl}"]`);
            if (recordRow) {
                // Выделяем строку
                document.querySelectorAll('.record-row').forEach(row => row.classList.remove('active'));
                recordRow.classList.add('active');

                // Заполняем форму данными из таблицы
                fillRecordFormFromRow(recordRow);

                // Устанавливаем ID записи и раздела
                recordIdInput.value = updateIdFromUrl;
                chapterIdInput.value = recordRow.getAttribute('data-chapter-id');

                // Устанавливаем заголовок модального окна
                recordModalTitle.textContent = 'Редактировать занятие';

                recordForm.setAttribute('action', '/ctps/ctp/' + ctpId.value + '/update');
                recordForm.setAttribute('th:object', '${updateRecord}');

                // Показываем модальное окно
                recordModal.show();
            }
        }

        const addRecordButtons = document.querySelectorAll('.add-record-btn');
        addRecordButtons.forEach(button => {
            button.addEventListener('click', function() {
                // Устанавливаем ID раздела
                const chapterId = this.getAttribute('data-chapter-id');
                chapterIdInput.value = chapterId;

                // Сбрасываем форму
                resetRecordForm();

                // Устанавливаем заголовок модального окна
                recordModalTitle.textContent = 'Добавить новое занятие';

                // Показываем модальное окно
                recordModal.show();
            });
        });

        editRecordItem.addEventListener('click', function() {
            if (!selectedRecordId) return;

            document.getElementById('updateId').value = selectedRecordId;

            // Находим строку таблицы с выбранной записью
            const recordRow = document.querySelector(`.record-row[data-record-id="${selectedRecordId}"]`);
            if (!recordRow) return;

            // Заполняем форму данными из таблицы
            fillRecordFormFromRow(recordRow);

            // Устанавливаем ID записи и раздела
            recordIdInput.value = selectedRecordId;
            chapterIdInput.value = recordRow.getAttribute('data-chapter-id');

            // Добавляем параметр updateId в URL
            const url = new URL(window.location);
            url.searchParams.set('updateId', selectedRecordId);
            window.history.pushState({}, '', url);

            // Устанавливаем заголовок модального окна
            recordModalTitle.textContent = 'Редактировать занятие';

            // Показываем модальное окно
            recordModal.show();

            // Скрываем контекстное меню
            recordContextMenu.style.display = 'none';
        });

        saveRecordBtn.addEventListener('click', function() {
            if (!validateRecordForm()) {
                alert('Пожалуйста, заполните все обязательные поля');
                return;
            }

            // Собираем данные формы
            const recordData = {
                id: recordIdInput.value || null,
                chapterId: chapterIdInput.value,
                title: recordTitleInput.value,
                hours: recordHoursInput.value,
                equipment: recordEquipmentInput.value,
                lessonType: recordLessonTypeSelect.value,
                homework: recordHomeworkTextarea.value,
                teachMethodsIds: teachMethodsSelect.val() || []
            };

            console.log('Данные для сохранения:', recordData);

            // Закрываем модальное окно
            recordModal.hide();
        });

        function fillRecordFormFromRow(row) {
            const cells = row.cells;

            // Заполняем основные поля
            recordTitleInput.value = cells[1].textContent;
            recordHoursInput.value = cells[2].textContent;
            recordEquipmentInput.value = cells[3].textContent;
            recordHomeworkTextarea.value = cells[6].textContent;

            // Устанавливаем тип занятия
            const lessonTypeText = cells[4].textContent;
            const lessonTypeOptions = recordLessonTypeSelect.options;
            for (let i = 0; i < lessonTypeOptions.length; i++) {
                if (lessonTypeOptions[i].textContent === lessonTypeText) {
                    recordLessonTypeSelect.value = lessonTypeOptions[i].value;
                    break;
                }
            }

            // Устанавливаем методы обучения
            const methodsText = cells[5].textContent;
            const selectedMethods = [];
            const methodOptions = teachMethodsSelect.find('option');

            methodOptions.each(function() {
                if (methodsText.includes(this.textContent)) {
                    selectedMethods.push(this.value);
                }
            });

            teachMethodsSelect.selectpicker('val', selectedMethods);
            teachMethodsSelect.selectpicker('refresh');
        }

        function resetRecordForm() {
            recordIdInput.value = '';
            recordTitleInput.value = '';
            recordHoursInput.value = '';
            recordEquipmentInput.value = '';
            recordLessonTypeSelect.value = '';
            recordHomeworkTextarea.value = '';
            teachMethodsSelect.selectpicker('val', []);
            teachMethodsSelect.selectpicker('refresh');

            // Удаляем параметр updateId из URL
            const url = new URL(window.location);
            url.searchParams.delete('updateId');
            window.history.pushState({}, '', url);
        }

        function validateRecordForm() {
            return recordTitleInput.value.trim() !== '' &&
                recordHoursInput.value.trim() !== '' &&
                recordLessonTypeSelect.value !== '';
        }

        // Обработчики для строк с записями
        const recordRows = document.querySelectorAll('.record-row');
        recordRows.forEach(row => {
            row.addEventListener('contextmenu', function(e) {
                e.preventDefault();

                selectedRecordId = this.getAttribute('data-record-id');
                selectedChapterId = this.getAttribute('data-chapter-id');

                recordContextMenu.style.display = 'block';
                chapterContextMenu.style.display = 'none';
                recordContextMenu.style.left = `${e.pageX}px`;
                recordContextMenu.style.top = `${e.pageY}px`;

                return false;
            });

            row.addEventListener('click', function() {
                // Удаляем активный класс у всех строк
                document.querySelectorAll('.record-row').forEach(r => r.classList.remove('active'));

                // Добавляем активный класс текущей строке
                this.classList.add('active');

                // Устанавливаем выбранный ID записи
                selectedRecordId = this.getAttribute('data-record-id');
                // Также устанавливаем chapterId для возможного редактирования
                chapterIdInput.value = this.getAttribute('data-chapter-id');

                // Заполняем форму данными из строки
                fillRecordFormFromRow(this);
            });
        });

        // Обработчики для заголовков разделов
        const chapterHeaders = document.querySelectorAll('tbody > tr:first-child');
        chapterHeaders.forEach(header => {
            header.addEventListener('contextmenu', function(e) {
                e.preventDefault();

                selectedChapterId = this.querySelector('button').getAttribute('data-chapter-id');

                chapterContextMenu.style.display = 'block';
                recordContextMenu.style.display = 'none';
                chapterContextMenu.style.left = `${e.pageX}px`;
                chapterContextMenu.style.top = `${e.pageY}px`;

                return false;
            });
        });

        // Закрытие контекстного меню при клике вне его
        document.addEventListener('click', function() {
            recordContextMenu.style.display = 'none';
            chapterContextMenu.style.display = 'none';
        });

        // Обработчики пунктов меню для записей
        editRecordItem.addEventListener('click', function() {
            recordContextMenu.style.display = 'none';
        });

        editRecordItem.addEventListener('click', function() {
            if (!selectedRecordId) return;

            // Находим строку таблицы с выбранной записью
            const recordRow = document.querySelector(`.record-row[data-record-id="${selectedRecordId}"]`);
            if (!recordRow) return;

            // Заполняем форму данными из таблицы
            fillRecordFormFromRow(recordRow);

            // Устанавливаем ID записи и раздела
            recordIdInput.value = selectedRecordId;
            chapterIdInput.value = recordRow.getAttribute('data-chapter-id');

            // Устанавливаем правильный action для формы
            recordForm.setAttribute('action', '/ctps/ctp/' + ctpId.value + '/update');
            recordForm.setAttribute('th:object', '${updateRecord}');

            // Устанавливаем заголовок модального окна
            recordModalTitle.textContent = 'Редактировать занятие';

            // Показываем модальное окно
            recordModal.show();

            // Скрываем контекстное меню
            recordContextMenu.style.display = 'none';
        });

        deleteRecordItem.addEventListener('click', function() {
            // Устанавливаем ID для удаления
            deleteIdInput.value = selectedRecordId;

            // Добавляем параметр deleteId в URL
            const url = new URL(window.location);
            url.searchParams.set('deleteId', selectedRecordId);
            window.history.pushState({}, '', url);

            confirmDeleteModal.show();
            recordContextMenu.style.display = 'none';
        });

        // Обработчики пунктов меню для разделов
        editChapterItem.addEventListener('click', function() {
            alert(`Редактирование раздела с ID: ${selectedChapterId}`);
            chapterContextMenu.style.display = 'none';
        });

        deleteChapterItem.addEventListener('click', function() {
            confirmDeleteModal.show();
            chapterContextMenu.style.display = 'none';
        });

        addRecordToChapterItem.addEventListener('click', function() {
            // Устанавливаем ID раздела
            chapterIdInput.value = selectedChapterId;

            // Сбрасываем форму
            resetRecordForm();

            // Устанавливаем заголовок модального окна
            recordModalTitle.textContent = 'Добавить новое занятие';

            // Показываем модальное окно
            recordModal.show();

            chapterContextMenu.style.display = 'none';
        });

        // Обработчик закрытия модального окна удаления
        confirmDeleteModal._element.addEventListener('hidden.bs.modal', function () {
            // Удаляем параметр deleteId из URL после закрытия модального окна
            const url = new URL(window.location);
            url.searchParams.delete('deleteId');
            window.history.pushState({}, '', url);
        });

        // Обработчик закрытия модального окна редактирования
        recordModal._element.addEventListener('hidden.bs.modal', function () {
            // Удаляем параметр updateId из URL после закрытия модального окна
            const url = new URL(window.location);
            url.searchParams.delete('updateId');
            window.history.pushState({}, '', url);

            // Возвращаем исходный action формы
            recordForm.setAttribute('action', '/ctps/ctp/' + ctpId.value + '/save');
            recordForm.setAttribute('th:object', '${newRecord}');
        });
    });
</script>
</body>
</html>